!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).Kune=t()}(this,function(){"use strict";var n=function(e,t){return(n=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(e,t){e.__proto__=t}:function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}))(e,t)};var o,h,s=function(){return(s=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var s in t=arguments[n])Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s]);return e}).apply(this,arguments)},e={exports:{}};function r(){}function i(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function c(e,t,n,o,s){if("function"!=typeof n)throw new TypeError("The listener must be a function");n=new i(n,o||e,s),o=h?h+t:t;return e._events[o]?e._events[o].fn?e._events[o]=[e._events[o],n]:e._events[o].push(n):(e._events[o]=n,e._eventsCount++),e}function a(e,t){0==--e._eventsCount?e._events=new r:delete e._events[t]}function t(){this._events=new r,this._eventsCount=0}f=e,o=Object.prototype.hasOwnProperty,h="~",Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(h=!1)),t.prototype.eventNames=function(){var e,t,n=[];if(0===this._eventsCount)return n;for(t in e=this._events)o.call(e,t)&&n.push(h?t.slice(1):t);return Object.getOwnPropertySymbols?n.concat(Object.getOwnPropertySymbols(e)):n},t.prototype.listeners=function(e){var e=h?h+e:e,t=this._events[e];if(!t)return[];if(t.fn)return[t.fn];for(var n=0,o=t.length,s=new Array(o);n<o;n++)s[n]=t[n].fn;return s},t.prototype.listenerCount=function(e){e=h?h+e:e,e=this._events[e];return e?e.fn?1:e.length:0},t.prototype.emit=function(e,t,n,o,s,r){var i=h?h+e:e;if(!this._events[i])return!1;var c,a=this._events[i],p=arguments.length;if(a.fn){switch(a.once&&this.removeListener(e,a.fn,void 0,!0),p){case 1:return a.fn.call(a.context),!0;case 2:return a.fn.call(a.context,t),!0;case 3:return a.fn.call(a.context,t,n),!0;case 4:return a.fn.call(a.context,t,n,o),!0;case 5:return a.fn.call(a.context,t,n,o,s),!0;case 6:return a.fn.call(a.context,t,n,o,s,r),!0}for(u=1,c=new Array(p-1);u<p;u++)c[u-1]=arguments[u];a.fn.apply(a.context,c)}else for(var l,f=a.length,u=0;u<f;u++)switch(a[u].once&&this.removeListener(e,a[u].fn,void 0,!0),p){case 1:a[u].fn.call(a[u].context);break;case 2:a[u].fn.call(a[u].context,t);break;case 3:a[u].fn.call(a[u].context,t,n);break;case 4:a[u].fn.call(a[u].context,t,n,o);break;default:if(!c)for(l=1,c=new Array(p-1);l<p;l++)c[l-1]=arguments[l];a[u].fn.apply(a[u].context,c)}return!0},t.prototype.on=function(e,t,n){return c(this,e,t,n,!1)},t.prototype.once=function(e,t,n){return c(this,e,t,n,!0)},t.prototype.removeListener=function(e,t,n,o){e=h?h+e:e;if(this._events[e])if(t){var s=this._events[e];if(s.fn)s.fn!==t||o&&!s.once||n&&s.context!==n||a(this,e);else{for(var r=0,i=[],c=s.length;r<c;r++)(s[r].fn!==t||o&&!s[r].once||n&&s[r].context!==n)&&i.push(s[r]);i.length?this._events[e]=1===i.length?i[0]:i:a(this,e)}}else a(this,e);return this},t.prototype.removeAllListeners=function(e){return e?(e=h?h+e:e,this._events[e]&&a(this,e)):(this._events=new r,this._eventsCount=0),this},t.prototype.off=t.prototype.removeListener,t.prototype.addListener=t.prototype.on,t.prefixed=h,f.exports=t.EventEmitter=t;var p=e.exports,l=v,f=p;if("function"!=typeof f&&null!==f)throw new TypeError("Class extends value "+String(f)+" is not a constructor or null");function u(){this.constructor=l}function v(e){var n=p.call(this)||this,t=(n.sid="",n.handleMessage=function(e){var t=JSON.parse(e.data);"protocol"===(null==t?void 0:t.type)?n.handleProtocolMessage(e):n.emit("message",e)},n.handleWsOpen=function(e){n.emit("open",e)},n.handleWsError=function(e){n.emit("error",e)},n.handleWsClose=function(e){n.emit("close",e)},e.url),e=e.topic;return n.topic=e,n.url=t,n.wsInst=new WebSocket(t,e),n.initEventsListeners(),n}return n(l,f),l.prototype=null===f?Object.create(f):(u.prototype=f.prototype,new u),v.prototype.send=function(e,t){void 0===t&&(t={type:"json"}),t="string"==typeof e?{data:e,type:t.type}:s(s({},e),{type:t.type||e.type}),console.log("send",JSON.stringify(t)),this.wsInst.send(JSON.stringify(t))},v.prototype.close=function(){this.wsInst.close()},v.prototype.handleProtocolMessage=function(e){var t=JSON.parse(e.data);"protocol"===t.type&&(console.log("[kune] protocol:",t),this.sid=t.data.sid,e.preventDefault(),e.stopPropagation())},v.prototype.initEventsListeners=function(){this.wsInst.addEventListener("message",this.handleMessage),this.wsInst.addEventListener("error",this.handleWsError),this.wsInst.addEventListener("close",this.handleWsClose),this.wsInst.addEventListener("open",this.handleWsOpen)},v.prototype.removeEventsListeners=function(){this.wsInst.removeEventListener("message",this.handleMessage),this.wsInst.removeEventListener("error",this.handleWsError),this.wsInst.removeEventListener("close",this.handleWsClose),this.wsInst.removeEventListener("open",this.handleWsOpen)},v.prototype.destroy=function(){this.removeEventsListeners(),this.wsInst.close()},v});
